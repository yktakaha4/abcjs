<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Timing Callbacks | abcjs</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="JavaScript library for displaying sheet music in a browser.">
    <link rel="preload" href="/abcjs/assets/css/0.styles.0a0de2ed.css" as="style"><link rel="preload" href="/abcjs/assets/js/app.16ae2c04.js" as="script"><link rel="preload" href="/abcjs/assets/js/4.e133f8a4.js" as="script"><link rel="preload" href="/abcjs/assets/js/14.ee6e7b98.js" as="script"><link rel="preload" href="/abcjs/assets/js/6.e6afa5e6.js" as="script"><link rel="preload" href="/abcjs/assets/js/7.cdaccca3.js" as="script"><link rel="prefetch" href="/abcjs/assets/js/1.ecd11f93.js"><link rel="prefetch" href="/abcjs/assets/js/10.1e746f6b.js"><link rel="prefetch" href="/abcjs/assets/js/11.624acb6b.js"><link rel="prefetch" href="/abcjs/assets/js/12.3a5d71bf.js"><link rel="prefetch" href="/abcjs/assets/js/13.4d894da2.js"><link rel="prefetch" href="/abcjs/assets/js/15.4229ca8b.js"><link rel="prefetch" href="/abcjs/assets/js/16.5c8c02c9.js"><link rel="prefetch" href="/abcjs/assets/js/17.093f4c6e.js"><link rel="prefetch" href="/abcjs/assets/js/18.89649559.js"><link rel="prefetch" href="/abcjs/assets/js/19.1f83564d.js"><link rel="prefetch" href="/abcjs/assets/js/2.09eef6c6.js"><link rel="prefetch" href="/abcjs/assets/js/20.2a9b0f8d.js"><link rel="prefetch" href="/abcjs/assets/js/21.1bc15009.js"><link rel="prefetch" href="/abcjs/assets/js/22.a319dd0e.js"><link rel="prefetch" href="/abcjs/assets/js/23.7d3e5ab0.js"><link rel="prefetch" href="/abcjs/assets/js/24.ff86ed32.js"><link rel="prefetch" href="/abcjs/assets/js/25.ab56f75e.js"><link rel="prefetch" href="/abcjs/assets/js/26.b390efb0.js"><link rel="prefetch" href="/abcjs/assets/js/27.9fcf5c55.js"><link rel="prefetch" href="/abcjs/assets/js/28.0164cdc9.js"><link rel="prefetch" href="/abcjs/assets/js/29.e8355ec7.js"><link rel="prefetch" href="/abcjs/assets/js/30.79104982.js"><link rel="prefetch" href="/abcjs/assets/js/31.a4ff18a2.js"><link rel="prefetch" href="/abcjs/assets/js/32.09b9d8b7.js"><link rel="prefetch" href="/abcjs/assets/js/33.adb3beee.js"><link rel="prefetch" href="/abcjs/assets/js/34.fca13930.js"><link rel="prefetch" href="/abcjs/assets/js/35.6f4067d1.js"><link rel="prefetch" href="/abcjs/assets/js/36.7a6eed21.js"><link rel="prefetch" href="/abcjs/assets/js/37.638405f4.js"><link rel="prefetch" href="/abcjs/assets/js/38.c830ff30.js"><link rel="prefetch" href="/abcjs/assets/js/5.4ac322c8.js"><link rel="prefetch" href="/abcjs/assets/js/8.b6caa845.js"><link rel="prefetch" href="/abcjs/assets/js/9.0851c050.js">
    <link rel="stylesheet" href="/abcjs/assets/css/0.styles.0a0de2ed.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/abcjs/" class="home-link router-link-active"><img src="/abcjs/img/abcjs_comp_extended_08.svg" alt="abcjs" class="logo"> <span class="site-name can-hide">abcjs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Overview</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Visual</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Audio</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Animation</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/abcjs/animation/timing-callbacks.html" aria-current="page" class="active sidebar-link">Timing Callbacks</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/abcjs/animation/timing-callbacks.html#creation" class="sidebar-link">Creation</a></li><li class="sidebar-sub-header"><a href="/abcjs/animation/timing-callbacks.html#parameters" class="sidebar-link">Parameters</a></li><li class="sidebar-sub-header"><a href="/abcjs/animation/timing-callbacks.html#callbacks" class="sidebar-link">Callbacks</a></li><li class="sidebar-sub-header"><a href="/abcjs/animation/timing-callbacks.html#functions" class="sidebar-link">Functions</a></li><li class="sidebar-sub-header"><a href="/abcjs/animation/timing-callbacks.html#example" class="sidebar-link">Example</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Interactive</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Analysis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Deprecated</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Developers</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Upgrading</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="timing-callbacks"><a href="#timing-callbacks" class="header-anchor">#</a> Timing Callbacks</h1> <p>This runs an animation timer and does callbacks at various intervals. This allows you to do various effects that are timed with beats or playing notes.</p> <h2 id="creation"><a href="#creation" class="header-anchor">#</a> Creation</h2> <p>To use this create an instance of it:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> timingCallbacks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">abcjs<span class="token punctuation">.</span>TimingCallbacks</span><span class="token punctuation">(</span>visualObj<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><table><thead><tr><th>Parameters</th> <th>Description</th></tr></thead> <tbody><tr><td>visualObj</td> <td>This is the output of the <code>renderAbc()</code> call. It is the music that will be timed.</td></tr> <tr><td>params</td> <td>This is a object. See below for the possible properties.</td></tr></tbody></table> <h2 id="parameters"><a href="#parameters" class="header-anchor">#</a> Parameters</h2> <table><thead><tr><th>Name</th> <th>Default</th> <th>Description</th></tr></thead> <tbody><tr><td><code>qpm</code></td> <td>whatever is in the Q: field</td> <td>Number of beats per minute.</td></tr> <tr><td><code>extraMeasuresAtBeginning</code></td> <td>0</td> <td>Don't start the callbacks right away, but insert this number of measures first.</td></tr> <tr><td><code>beatCallback</code></td> <td>null</td> <td>Called for each beat passing the beat number (starting at 0).</td></tr> <tr><td><code>eventCallback</code></td> <td>null</td> <td>Called for each event (either a note, a rest, or a chord, and notes in separate voices are grouped together.)</td></tr> <tr><td><code>lineEndCallback</code></td> <td>null</td> <td>Called at the end of each line. (This is useful if you want to be sure the music is scrolled into view at the right time.) See <code>lineEndAnticipation</code> for more details.</td></tr> <tr><td><code>lineEndAnticipation</code></td> <td>0</td> <td>The number of milliseconds for the <code>lineEndCallback</code> to anticipate end of the line. That is, if you want to get the callback half a second before the end of the line, use 500.</td></tr> <tr><td><code>beatSubdivisions</code></td> <td>1</td> <td>How many callbacks should happen for each beat. This allows finer control in the client, for instance, to handle a progress bar.</td></tr></tbody></table> <h2 id="callbacks"><a href="#callbacks" class="header-anchor">#</a> Callbacks</h2> <h3 id="beatcallback"><a href="#beatcallback" class="header-anchor">#</a> beatCallback</h3> <p>This is called once for every beat in the tune. It is called one additional time when the tune is finished.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">beatCallback</span><span class="token punctuation">(</span><span class="token parameter">beatNumber<span class="token punctuation">,</span> totalBeats<span class="token punctuation">,</span> totalTime<span class="token punctuation">,</span> position<span class="token punctuation">,</span> debugInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><table><thead><tr><th>Name</th> <th>Description</th></tr></thead> <tbody><tr><td>beatNumber</td> <td>Zero-based beat number. Usually this will increment sequentially and regularly, but if javascript is paused long enough (for instance, if the browser tab is changed), then there may be a number of these calls at once when it catches up.</td></tr> <tr><td>totalBeats</td> <td>The total number of beats (including all repeats) that will be played.</td></tr> <tr><td>totalTime</td> <td>The total number of milliseconds of the tune.</td></tr> <tr><td>position</td> <td>The interpolated position of the cursor if the beat occurs between notes. This is an object with the attributes { left: , top: , height: } This can be used to smooth out the cursor by moving it on the beat callbacks. The higher the number of <code>beatSubdivisions</code> the smoother the cursor will be.</td></tr> <tr><td>debugInfo</td> <td>A hash of some extra info that might be useful in figuring out why the callback was triggered.</td></tr></tbody></table> <h3 id="eventcallback"><a href="#eventcallback" class="header-anchor">#</a> eventCallback</h3> <p>This is called once for every &quot;event&quot; in time - either a note or a rest. If there are multiple notes at the same time, then it is only called once
for that group of notes.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">eventCallback</span><span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>The parameter <code>ev</code> is an object that looks like this:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>ev <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;event&quot;</span><span class="token punctuation">,</span> <span class="token comment">// This is always &quot;event&quot;</span>

    <span class="token string">&quot;milliseconds&quot;</span><span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token comment">// The number of milliseconds from the beginning of the piece</span>
    <span class="token string">&quot;millisecondsPerMeasure&quot;</span><span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token comment">// The number of milliseconds per measure</span>

    <span class="token string">&quot;line&quot;</span><span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token comment">// The current &quot;line&quot;, that is, the staff system.</span>
    <span class="token string">&quot;measureNumber&quot;</span><span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token comment">// The measure number. Resets per line, so the first measure number on a line is zero.</span>

    <span class="token string">&quot;top&quot;</span><span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token comment">// The number of pixels from the top of the svg that the note appears.</span>
    <span class="token string">&quot;height&quot;</span><span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token comment">// The height of the note, in pixels. </span>
    <span class="token string">&quot;left&quot;</span><span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token comment">// The number of pixels from the left edge of the svg.</span>
    <span class="token string">&quot;width&quot;</span><span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token comment">// The width of the note</span>

    <span class="token string">&quot;elements&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// Array of the actual elements on the page that are represented by the note or notes.</span>
    <span class="token string">&quot;startCharArray&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> number <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// the character position in the original abc string</span>
    <span class="token string">&quot;endCharArray&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> number <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// the character position in the original abc string</span>
    <span class="token string">&quot;midiPitches&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token comment">// Array of the currently playing pitches</span>
        <span class="token punctuation">{</span>
            <span class="token string">&quot;pitch&quot;</span><span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token comment">// The pitch number (based on the midi standard, i.e. middle C is 60)</span>
            <span class="token string">&quot;durationInMeasures&quot;</span><span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token comment">// the note value as a fraction. (that is, a quarter note is 0.025)</span>
            <span class="token string">&quot;volume&quot;</span><span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token comment">// The volume expressed as a number between 0 and 127</span>
            <span class="token string">&quot;instrument&quot;</span><span class="token operator">:</span> number <span class="token comment">// The instrument number (based on the midi standard, i.e. acoustic_grand_piano is 0)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="notes"><a href="#notes" class="header-anchor">#</a> Notes:</h4> <ul><li><p>The <code>startCharArray</code> and <code>endCharArray</code> are arrays because there is more than one location in the abc string if there is more than one voice.</p></li> <li><p>The format of the <code>elements</code> array is subject to change in future versions.</p></li> <li><p>This is called one last time with passing in <code>null</code> at the end of the tune. On that call <code>eventCallback</code> can return the string &quot;continue&quot; to keep the timer from stopping. This is useful if you want to play on repeat - in theory you would probably have another call to <code>seek()</code>.</p></li> <li><p>This function can be a Promise or not.</p></li></ul> <h3 id="lineendcallback"><a href="#lineendcallback" class="header-anchor">#</a> lineEndCallback</h3> <p>This will be called as the cursor is approaching the end of a line of music. This is useful if there is more than a screen's worth of music; it can be used to scroll the page at the right time.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">lineEndCallback</span><span class="token punctuation">(</span><span class="token parameter">info<span class="token punctuation">,</span> event<span class="token punctuation">,</span> details</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>The parameter <code>info</code> looks like this:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>info <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;milliseconds&quot;</span><span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token comment">// current milliseconds from beginning of piece</span>
    <span class="token string">&quot;top&quot;</span><span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token comment">// The number of pixels from the top of the svg to the top of the cursor</span>
    <span class="token string">&quot;bottom&quot;</span><span class="token operator">:</span> number <span class="token comment">// The number of pixels from the top of the svg to the bottom of the cursor</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The parameter <code>event</code> is the standard note event.</p> <p>The parameter <code>details</code> looks like this:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>details <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;line&quot;</span><span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token comment">// the current line number (zero-based)</span>
    <span class="token string">&quot;endTimings&quot;</span><span class="token operator">:</span> array <span class="token comment">// the array of the timings for each line</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The <code>endTimings</code> array elements are of the same type as the <code>info</code> parameter.</p> <h2 id="functions"><a href="#functions" class="header-anchor">#</a> Functions</h2> <p>These are the entry points that can be called on the <code>timingCallbacks</code> object.</p> <table><thead><tr><th>Name</th> <th>Description</th></tr></thead> <tbody><tr><td>replaceTarget(visualObj)</td> <td>If the underlying music changes on the fly, this replaces the current object without having to destroy the object and start over.</td></tr> <tr><td>start()</td> <td>Start or resume the animation immediately.</td></tr> <tr><td>pause()</td> <td>Pause the animation. After calling this, the next call to <code>start()</code> will pick up where it left off.</td></tr> <tr><td>reset()</td> <td>Move the timer back to the beginning, so the animation starts over.</td></tr> <tr><td>stop()</td> <td>Stop the animation. After calling this, the next call to <code>start()</code> will start at the beginning.</td></tr> <tr><td>setProgress(percent)</td> <td>Change the position of the animation. This allows random access to any place in the tune.</td></tr></tbody></table> <h2 id="example"><a href="#example" class="header-anchor">#</a> Example</h2> <p>Paste in any ABC you want here then click &quot;start&quot; to see what is returned by the timing callbacks:</p> <div class="example-tune-book"><div class="abcjs-editor"><textarea id="abc"></textarea> <div id="warnings"></div> <div id="paper"></div></div></div> <div class="timing-callbacks" data-v-3e754994><form data-v-3e754994><div class="language- my-code" data-v-3e754994><div data-v-3e754994>timer = new abcjs.TimingCallbacks(visualObj, {</div> <label data-v-3e754994><span data-v-3e754994>qpm: </span> <input type="number" min="4" max="300" step="4" value="100" data-v-3e754994>,
		</label> <label data-v-3e754994><span data-v-3e754994>extraMeasuresAtBeginning: </span> <input type="number" min="0" max="4" value="0" data-v-3e754994>,
		</label> <label data-v-3e754994><span data-v-3e754994>lineEndAnticipation: </span> <input type="number" min="0" max="4000" step="100" value="500" data-v-3e754994>,
		</label> <label data-v-3e754994><span data-v-3e754994>beatSubdivisions: </span> <input type="number" min="1" max="8" value="4" data-v-3e754994>,
		</label> <div data-v-3e754994></div> <div class="label-indent" data-v-3e754994>beatCallback: function() {...},</div> <div class="label-indent" data-v-3e754994>eventCallback: function() {...},</div> <div class="label-indent" data-v-3e754994>lineEndCallback: function() {...}</div> <div data-v-3e754994>}</div></div> <button type="submit" data-v-3e754994>Start()</button></form> <button data-v-3e754994>Stop()</button> <button data-v-3e754994>Pause()</button> <button data-v-3e754994>Reset()</button> <button data-v-3e754994>Set Progress(10)</button> <div data-v-3e754994><h3 data-v-3e754994>Output Stream:</h3> <div class="output" data-v-3e754994></div></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/abcjs/audio/synthesized-sound.html" class="prev">
        Synthesized Sound
      </a></span> <span class="next"><a href="/abcjs/interactive/interactive-editor.html">
        Interactive Editor
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/abcjs/assets/js/app.16ae2c04.js" defer></script><script src="/abcjs/assets/js/4.e133f8a4.js" defer></script><script src="/abcjs/assets/js/14.ee6e7b98.js" defer></script><script src="/abcjs/assets/js/6.e6afa5e6.js" defer></script><script src="/abcjs/assets/js/7.cdaccca3.js" defer></script>
  </body>
</html>
